<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Dont Eat (Me)</title>
    <script src="//cdn.jsdelivr.net/npm/phaser@3.11.0/dist/phaser.js"></script>
    <style type="text/css">
        body {
            margin: 0;
        }
    </style>
</head>
<body>

<script type="text/javascript">

var config = {
    type: Phaser.AUTO,
    width: 986,
    height: 600,
    physics: {
        default: 'arcade',
        arcade: {
            gravity: { y: 300 },
            debug: false
        }
    },
    scene: {
        preload: preload,
        create: create,
        update: update
    }
};


var LEVEL_TIME = 1*60; // in seconds
var BARKING_COOLDOWN = 3; // in seconds
var BARK_SPEED = 200;
var SLEEPING_TIME = 5; // in seconds

var cake;
var platforms;
var bottoms;
var dogs;
var barks;
var barkingSound;

var cherries = [];
var apples = [];

// numberOfCherries + numberOfApples needs to be less than 20
var numberOfCherries = 10;
var numberOfApples = 0;
var timeText;

var gameWonEvent;
var gameOver = false;

var cursors;
var keySpace;


var game = new Phaser.Game(config);

function preload ()
{
	// Background
    this.load.image('kitchen', 'assets/kitchen.png');
    
    // Platforms
    this.load.image('ground', 'assets/platform.png');
    this.load.image('bottom', 'assets/bottom.png');


	// Player
    this.load.spritesheet('cake', 'assets/cake-sprite.png', { frameWidth: 100, frameHeight: 100 });

    // Food assets
    this.load.image('apple', 'assets/food/Apple.png');
    this.load.image('cherry', 'assets/food/Cherry.png');
    this.load.image('fish', 'assets/food/Fish.png');
    this.load.image('peach', 'assets/food/Peach.png');
    this.load.image('strawberry', 'assets/food/Strawberry.png');
    this.load.image('tomato', 'assets/food/Tomato.png');

    // Dog assets
    this.load.image('dog', 'assets/pets/dog.png');
    this.load.image('barking', 'assets/projectiles/barking.png');
    this.load.audio('barkingSound', 'assets/pets/barking_sound.mp3');

}

function create ()
{
    //  A simple background for our game
    this.add.image(493, 300, 'kitchen');

    //  The platforms group contains the platforms for the cake
    platforms = this.physics.add.staticGroup();
    //  The bottoms group contains the floor that cats and dogs can walk on
    bottoms = this.physics.add.staticGroup();


    //  Here we create the ground.
    bottoms.create(493, 616, 'bottom').setVisible(false);

    //  Now let's create some ledges
    platforms.create(100, 334, 'ground').setVisible(false);
    platforms.create(500, 334, 'ground').setVisible(false);


    // The player and its settings
    cake = this.physics.add.sprite(200, 50, 'cake');
    //  Player physics properties. Give the little guy no bounce.
    cake.setBounce(0);
    cake.setCollideWorldBounds(true);

    // The dogs - currently only one
    dogs = this.physics.add.group();
    dog = dogs.create(100, 536, 'dog');
    dog.setData('barkingTimer', this.time.addEvent({
		delay: BARKING_COOLDOWN*1000,
		callbackScope: this,
		loop: true,
		callback: function () {
			bark(dog);
	    },
		}));
  
  
    dog.setData('sleepingTimer', this.time.addEvent({
		delay: SLEEPING_TIME*1000,
		callbackScope: this,
		loop: true,
		paused: true,
		callback: function () {
			// The dog does not sleep any longer, so it starts to bark
			dog.getData('sleepingTimer').paused = true;
			dog.getData('barkingTimer').paused = false;
		}
		}));

    barks = this.physics.add.group({ allowGravity: false })
    barkingSound = this.sound.add('barkingSound');



    //  Our player animations, turning, walking left and walking right.
    this.anims.create({
        key: 'left',
        frames: this.anims.generateFrameNumbers('cake', { start: 0, end: 3 }),
        frameRate: 10,
        repeat: -1
    });

    this.anims.create({
        key: 'turn',
        frames: [ { key: 'cake', frame: 4 } ],
        frameRate: 20
    });

    this.anims.create({
        key: 'right',
        frames: this.anims.generateFrameNumbers('cake', { start: 5, end: 8 }),
        frameRate: 10,
        repeat: -1
    });


    //  Input Events
    cursors = this.input.keyboard.createCursorKeys();
    keySpace = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.SPACE);


    //  cherries contains 20 cherries and apples 20 apples that can be
    //  set visible or invisible later
    for (var i = 0; i < 20; i++) {
		cherries.push(this.add.image(16+24*i, 16, 'cherry'));
		apples.push(this.add.image(16+24*i, 16, 'apple'));
	}
	for (cherry of cherries) {
		cherry.setVisible(false);
	}
	for (apple of apples) {
		apple.setVisible(false);
	}


    //  Collide
    this.physics.add.collider(cake, platforms);
    this.physics.add.collider(dogs, bottoms);
    
    this.physics.add.overlap(cake, barks, onBarkHit, null, this);

	// The time
	gameWonEvent = this.time.addEvent({ 
		delay: LEVEL_TIME*1000, 
		callback: onGameWon, 
		callbackScope: this 
		});
    timeText = this.add.text(981, 0, '', {font: '20pt Roboto', fill: '#000'}).setOrigin(1, 0);
    updateTime();
    
    // gamelost event
    this.events.on('gamelost', onGameLost, this);
    
}

function updateFruits () {
	for (var i = 0; i < numberOfCherries; i++) {
		cherries[i].setVisible(true);
		apples[i].setVisible(false);
	}
	for (var i = numberOfCherries; i < numberOfCherries+numberOfApples; i++) {
		cherries[i].setVisible(false);
		apples[i].setVisible(true);
	}
	for (var i = numberOfCherries+numberOfApples; i < 20; i++) {
		cherries[i].setVisible(false);
		apples[i].setVisible(false);
	}
}

function updateTime() {
	var timeRemaining = LEVEL_TIME - gameWonEvent.getElapsedSeconds();
	timeText.setText(Math.floor(timeRemaining/60).toString().padStart(2, '0')
	                 + ':'
	                 + Math.floor(timeRemaining % 60).toString().padStart(2, '0'));

}

function updateBarks() {
	// remove barks that are out of bounds
	barks.children.each(function (child) {
		if (Math.abs(child.x) > 1000 || Math.abs(child.y) > 1000) {
			// the bark is definitely out of bounds
			child.destroy()
		}
	});	
}

function bark(dog) {
	dogMouth = dog.getCenter().add(new Phaser.Math.Vector2(100, -75));
	// this is the offset of the cake from the mouth of the dog
	offset = cake.getCenter().subtract(dogMouth);
	rotation = offset.angle();
	velocity = offset.normalize().scale(BARK_SPEED);
	
	barks.create(dogMouth.x, dogMouth.y, 'barking')
	     .setRotation(rotation)
	     .setVelocityX(velocity.x)
	     .setVelocityY(velocity.y);

    barkingSound.play();
	console.log('bark');
}


function update ()
{
    if (gameOver)
    {
        return;
    }

    if (cursors.left.isDown)
    {
        cake.setVelocityX(-160);
        cake.anims.play('left', true);
     }
	else if (cursors.right.isDown)
	{
		cake.setVelocityX(160);
		cake.anims.play('right', true);
	}
	else
	{
		cake.setVelocityX(0);
		cake.anims.play('turn');
	}

	if (cursors.up.isDown && cake.body.touching.down)
	{
		cake.setVelocityY(-330);
	}

	updateTime();
	updateFruits();
	updateBarks();
}

function onBarkHit(cake, bark) {
	// the cake was hit by a bark
	numberOfCherries--;
	bark.destroy();
	if (numberOfCherries <= 0) {
		numberOfCherries = 0;
		updateFruits();
		this.events.emit('gamelost');
	}
}

function onGameWon () {
	this.physics.pause();
	this.time.removeAllEvents();
	this.add.text(493, 300, 'You won', {font: '40pt Roboto', fill: '#000'}).setOrigin(0.5, 0.5);
	gameOver = true;
}

function onGameLost () {
	this.physics.pause();
	this.time.removeAllEvents();
	this.add.text(493, 300, 'You lost', {font: '40pt Roboto', fill: '#000'}).setOrigin(0.5, 0.5);
	gameOver = true;	
}

</script>

</body>
</html>
